<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Polling Lomba Menggambar dan Mewarnai Pesta Gotilon 2025</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');
  body {
    margin: 0;
    font-family: 'Poppins', sans-serif;
    background: linear-gradient(135deg, #7f0000, #ff6300);
    color: #fff8f0;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 1rem;
  }
  h1 {
    margin-bottom: 0.25rem;
    font-weight: 600;
    font-size: 1.8rem;
    text-align: center;
    text-shadow: 1px 1px 4px #0008;
  }
  #container {
    width: 100%;
    max-width: 460px;
    background-color: #4a0f02cc;
    border-radius: 12px;
    box-shadow: 0 0 16px #ff630080;
    padding: 1.2rem 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    user-select: none;
  }
  .section {
    background: #6e180012;
    border-radius: 10px;
    padding: 1rem;
    box-shadow: inset 0 0 6px #ff630080;
  }

  /* Respondent area */
  #respondent-section h2 {
    margin: 0 0 1rem 0;
    font-weight: 600;
    font-size: 1.3rem;
    text-align: center;
    text-shadow: 1px 1px 3px #0008;
  }
  #respondent-token-form,
  #respondent-vote-form {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    align-items: center;
  }
  input[type=text] {
    width: 80%;
    padding: 0.5rem 0.75rem;
    border-radius: 8px;
    border: none;
    font-size: 1rem;
  }
  button {
    cursor: pointer;
    background: #ff6300;
    border: none;
    color: #fff8f0;
    font-weight: 600;
    padding: 0.55rem 1.25rem;
    font-size: 1.1rem;
    border-radius: 10px;
    box-shadow: 0 0 8px #ff6300dd;
    transition: background-color 0.3s ease, box-shadow 0.3s ease;
  }
  button:hover:not(:disabled) {
    background: #ff9922;
    box-shadow: 0 0 14px #ff9922cc;
  }
  button:disabled {
    background: #7a3b00aa;
    cursor: default;
    box-shadow: none;
  }
  label {
    font-weight: 500;
    user-select: none;
  }
  select {
    width: 90%;
    padding: 0.5rem 0.75rem;
    font-size: 1rem;
    border-radius: 8px;
    border: none;
    outline: none;
  }

  /* Admin area */
  #admin-section h2 {
    margin: 0 0 1rem 0;
    font-weight: 600;
    font-size: 1.3rem;
    text-align: center;
    text-shadow: 1px 1px 3px #0008;
  }
  #admin-login-form,
  #admin-panel {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    align-items: center;
  }
  input[type=password] {
    width: 80%;
    padding: 0.5rem 0.75rem;
    border-radius: 8px;
    border: none;
    font-size: 1rem;
  }
  #tokens-list {
    max-height: 150px;
    overflow-y: auto;
    width: 100%;
    background: #7f240044;
    padding: 0.8rem;
    border-radius: 8px;
    font-size: 0.9rem;
    box-shadow: inset 0 0 7px #ff630099;
  }
  #tokens-list ul {
    margin: 0;
    padding-left: 1.2rem;
    list-style-type: disc;
    line-height: 1.3;
  }
  #results-table {
    border-collapse: collapse;
    width: 100%;
    margin-top: 0.5rem;
  }
  #results-table th, #results-table td {
    border: 1px solid #ff630088;
    padding: 6px 8px;
    text-align: center;
    font-size: 0.9rem;
  }
  #results-table th {
    background-color: #9c3600cc;
  }
  .small-note {
    font-size: 0.75rem;
    opacity: 0.8;
    font-style: italic;
  }
  #admin-actions {
    display: flex;
    gap: 0.8rem;
    flex-wrap: wrap;
    justify-content: center;
  }

  /* Radio list for choices */
  .radio-group {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    justify-content: center;
  }
  .radio-group label {
    background-color: #a63b00bb;
    padding: 0.5rem 1rem;
    border-radius: 10px;
    cursor: pointer;
    flex: 1 0 100px;
    text-align: center;
    user-select: none;
    transition: background-color 0.3s ease;
  }
  .radio-group input[type=radio] {
    display: none;
  }
  .radio-group input[type=radio]:checked + label {
    background-color: #ff6300;
    color: #fff8f0;
    font-weight: 700;
    box-shadow: 0 0 10px #ff6300bb;
  }

  /* Responsive and spacing */
  @media (max-width: 500px) {
    #container {
      width: 100%;
      padding: 1rem;
    }
  }
</style>
</head>
<body>
<h1>Polling Lomba Menggambar dan Mewarnai Pesta Gotilon 2025</h1>
<div id="container">
  <!-- Respondent Section -->
  <section id="respondent-section" class="section">
    <h2>Polling Responden</h2>
    <div id="respondent-token-entry">
      <form id="respondent-token-form">
        <label for="token-input">Masukkan Token Anda:</label>
        <input type="text" id="token-input" autocomplete="off" required placeholder="Token unik" />
        <button type="submit">Masuk</button>
      </form>
      <p id="token-error" style="color:#ffb1b1;display:none;margin-top:0.4rem;text-align:center;"></p>
    </div>
    <div id="respondent-vote-area" style="display:none;">
      <form id="respondent-vote-form">
        <label>Pilih Lomba:</label>
        <div class="radio-group" id="competition-choice">
          <input type="radio" id="mewarnai" name="competition" value="Mewarnai" required />
          <label for="mewarnai">Mewarnai</label>

          <input type="radio" id="menggambar" name="competition" value="Menggambar" />
          <label for="menggambar">Menggambar</label>
        </div>
        <label>Pilih Sektor:</label>
        <div class="radio-group" id="sector-choice">
          <input type="radio" id="sektor1" name="sector" value="Sektor 1" required />
          <label for="sektor1">Sektor 1</label>

          <input type="radio" id="sektor2" name="sector" value="Sektor 2" />
          <label for="sektor2">Sektor 2</label>

          <input type="radio" id="sektor3" name="sector" value="Sektor 3" />
          <label for="sektor3">Sektor 3</label>

          <input type="radio" id="sektor4" name="sector" value="Sektor 4" />
          <label for="sektor4">Sektor 4</label>

          <input type="radio" id="sektor5" name="sector" value="Sektor 5" />
          <label for="sektor5">Sektor 5</label>

          <input type="radio" id="sektor6" name="sector" value="Sektor 6" />
          <label for="sektor6">Sektor 6</label>

          <input type="radio" id="sektor7" name="sector" value="Sektor 7" />
          <label for="sektor7">Sektor 7</label>
        </div>
        <button type="submit">Kirim Vote</button>
      </form>
    </div>
    <p id="vote-confirm" style="color:#a8ffb1;display:none;margin-top:0.6rem;text-align:center;font-weight:600;">Terima kasih atas partisipasi Anda!</p>
  </section>

  <!-- Admin Section -->
  <section id="admin-section" class="section">
    <h2>Admin Panel</h2>

    <div id="admin-login-area">
      <form id="admin-login-form">
        <label for="admin-password-input">Password Admin:</label>
        <input type="password" id="admin-password-input" autocomplete="off" required placeholder="Masukkan password"/>
        <button type="submit">Login</button>
      </form>
      <p id="admin-login-error" style="color:#ffb1b1;display:none;margin-top:0.4rem;text-align:center;"></p>
    </div>

    <div id="admin-panel" style="display:none;">
      <div id="admin-actions">
        <button id="generate-token-btn" title="Buat token acak baru">Buat Token Random</button>
        <button id="export-data-btn" title="Ekspor data token & vote JSON">Ekspor Data JSON</button>
        <button id="import-data-btn" title="Impor data JSON (salin tempel) dari file/data lama">Impor Data JSON</button>
        <button id="admin-logout-btn" style="background:#a03000;" title="Logout Admin">Logout</button>
      </div>

      <div style="margin-top:1rem; max-height: 150px; overflow-y:auto; background:#7f240044; border-radius:8px; padding:0.6rem; box-shadow: inset 0 0 7px #ff630099;">
        <strong>Daftar Token (status):</strong>
        <ul id="tokens-list" aria-live="polite" aria-relevant="additions"></ul>
      </div>

      <div style="margin-top:1rem;">
        <strong>Hasil Pemungutan Suara:</strong>
        <table id="results-table" aria-label="Hasil Voting">
          <thead>
            <tr>
              <th>Lomba</th>
              <th>Sektor 1</th>
              <th>Sektor 2</th>
              <th>Sektor 3</th>
              <th>Sektor 4</th>
              <th>Sektor 5</th>
              <th>Sektor 6</th>
              <th>Sektor 7</th>
            </tr>
          </thead>
          <tbody id="results-body">
          </tbody>
        </table>
      </div>

      <p class="small-note" style="margin-top:0.5rem; text-align:center;">
        Data tersimpan di browser. To share, gunakan tombol ekspor dan impor data JSON.
      </p>
      <textarea id="import-export-area" placeholder="Tempel data di sini untuk impor" style="margin-top:0.8rem; width: 100%; height: 6rem; border-radius: 8px; resize: vertical; padding: 0.5rem; display:none;"></textarea>
      <button id="confirm-import-btn" style="display:none; margin-top: 0.4rem;">Konfirmasi Impor Data</button>
    </div>
  </section>
</div>

<script>
(() => {
  const TOKEN_STORAGE = 'gotilon2025_tokens';
  const VOTE_STORAGE = 'gotilon2025_votes';
  const ADMIN_SESSION_KEY = 'gotilon2025_admin_logged';

  // Elements - Respondent
  const respondentTokenEntry = document.getElementById('respondent-token-entry');
  const respondentTokenForm = document.getElementById('respondent-token-form');
  const tokenInput = document.getElementById('token-input');
  const tokenError = document.getElementById('token-error');

  const respondentVoteArea = document.getElementById('respondent-vote-area');
  const respondentVoteForm = document.getElementById('respondent-vote-form');
  const voteConfirm = document.getElementById('vote-confirm');

  // Elements - Admin
  const adminLoginArea = document.getElementById('admin-login-area');
  const adminLoginForm = document.getElementById('admin-login-form');
  const adminPasswordInput = document.getElementById('admin-password-input');
  const adminLoginError = document.getElementById('admin-login-error');

  const adminPanel = document.getElementById('admin-panel');
  const generateTokenBtn = document.getElementById('generate-token-btn');
  const tokensList = document.getElementById('tokens-list');
  const resultsBody = document.getElementById('results-body');

  const exportDataBtn = document.getElementById('export-data-btn');
  const importDataBtn = document.getElementById('import-data-btn');
  const importExportArea = document.getElementById('import-export-area');
  const confirmImportBtn = document.getElementById('confirm-import-btn');
  const adminLogoutBtn = document.getElementById('admin-logout-btn');

  // Voting options constants
  const competitions = ['Mewarnai', 'Menggambar'];
  const sectors = ['Sektor 1', 'Sektor 2', 'Sektor 3', 'Sektor 4', 'Sektor 5', 'Sektor 6', 'Sektor 7'];

  // State
  let tokens = {};
  let votes = {};
  let currentToken = null;
  let adminLoggedIn = false;

  // --- Initialization ---
  function loadTokens() {
    try {
      tokens = JSON.parse(localStorage.getItem(TOKEN_STORAGE)) || {};
    } catch {
      tokens = {};
    }
  }
  function saveTokens() {
    localStorage.setItem(TOKEN_STORAGE, JSON.stringify(tokens));
  }

  function loadVotes() {
    try {
      votes = JSON.parse(localStorage.getItem(VOTE_STORAGE)) || {};
    } catch {
      votes = {};
    }
  }
  function saveVotes() {
    localStorage.setItem(VOTE_STORAGE, JSON.stringify(votes));
  }

  function resetRespondentViews() {
    respondentTokenEntry.style.display = 'block';
    tokenError.style.display = 'none';
    respondentVoteArea.style.display = 'none';
    voteConfirm.style.display = 'none';
    respondentVoteForm.reset();
    tokenInput.value = '';
    currentToken = null;
  }

  function resetAdminViews() {
    adminLoginArea.style.display = 'block';
    adminPanel.style.display = 'none';
    adminPasswordInput.value = '';
    adminLoginError.style.display = 'none';
  }

  function renderTokenList() {
    tokensList.innerHTML = '';
    if (Object.keys(tokens).length === 0) {
      tokensList.innerHTML = '<li>Tidak ada token yang dibuat.</li>';
      return;
    }
    const ul = document.createElement('ul');
    Object.entries(tokens).forEach(([token, used]) => {
      const li = document.createElement('li');
      li.textContent = token + ' — ' + (used ? 'Sudah Digunakan' : 'Belum Digunakan');
      li.style.color = used ? '#a8ffb1' : '#ffb1b1';
      ul.appendChild(li);
    });
    tokensList.appendChild(ul);
  }

  function renderResults() {
    // Initialize results data with zeros for each competition-sector
    const resultData = {};
    competitions.forEach(comp => {
      resultData[comp] = {};
      sectors.forEach(sec => {
        resultData[comp][sec] = 0;
      });
    });
    // Aggregate votes counts
    Object.values(votes).forEach(vote => {
      if (resultData[vote.competition] && resultData[vote.competition][vote.sector] !== undefined) {
        resultData[vote.competition][vote.sector]++;
      }
    });

    resultsBody.innerHTML = '';
    competitions.forEach(comp => {
      const tr = document.createElement('tr');
      const tdComp = document.createElement('td');
      tdComp.textContent = comp;
      tdComp.style.fontWeight = '600';
      tr.appendChild(tdComp);
      sectors.forEach(sec => {
        const td = document.createElement('td');
        td.textContent = resultData[comp][sec];
        tr.appendChild(td);
      });
      resultsBody.appendChild(tr);
    });
  }

  // Helper: generate random token string (8 uppercase alphanumeric)
  function generateRandomToken() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let token = '';
    for (let i = 0; i < 8; i++) {
      token += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return token;
  }

  // Admin login check
  function checkAdminSession() {
    adminLoggedIn = (localStorage.getItem(ADMIN_SESSION_KEY) === 'true');
    if (adminLoggedIn) {
      adminLoginArea.style.display = 'none';
      adminPanel.style.display = 'flex';
      renderTokenList();
      renderResults();
    } else {
      resetAdminViews();
    }
  }

  // --- Event Handlers ---

  // Respondent enters token
  respondentTokenForm.addEventListener('submit', e => {
    e.preventDefault();
    const tokenVal = tokenInput.value.trim().toUpperCase();
    if (!tokenVal) return;
    if (!(tokenVal in tokens)) {
      tokenError.textContent = 'Token tidak valid.';
      tokenError.style.display = 'block';
      return;
    }
    if (tokens[tokenVal]) {
      tokenError.textContent = 'Token sudah digunakan.';
      tokenError.style.display = 'block';
      return;
    }
    // Token valid and unused
    tokenError.style.display = 'none';
    currentToken = tokenVal;
    // Hide token input, show vote
    respondentTokenEntry.style.display = 'none';
    respondentVoteArea.style.display = 'block';
  });

  // Respondent submits vote
  respondentVoteForm.addEventListener('submit', e => {
    e.preventDefault();
    if (!currentToken) {
      tokenError.textContent = 'Token tidak dikenali. Silakan mulai ulang.';
      tokenError.style.display = 'block';
      resetRespondentViews();
      return;
    }
    const competition = respondentVoteForm.elements['competition'].value;
    const sector = respondentVoteForm.elements['sector'].value;
    if (!competition || !sector) return;

    // Save vote
    votes[currentToken] = { competition, sector };
    saveVotes();

    // Mark token as used
    tokens[currentToken] = true;
    saveTokens();

    voteConfirm.style.display = 'block';

    // Reset to token screen after a short delay
    setTimeout(() => {
      resetRespondentViews();
    }, 2500);
  });

  // Admin login submit
  adminLoginForm.addEventListener('submit', e => {
    e.preventDefault();
    const pass = adminPasswordInput.value.trim();
    if (pass === 'semutsektor32025') {
      localStorage.setItem(ADMIN_SESSION_KEY, 'true');
      checkAdminSession();
    } else {
      adminLoginError.textContent = 'Password salah.';
      adminLoginError.style.display = 'block';
    }
  });

  // Admin logout click
  adminLogoutBtn.addEventListener('click', () => {
    localStorage.removeItem(ADMIN_SESSION_KEY);
    adminLoggedIn = false;
    resetAdminViews();
  });

  // Generate token click
  generateTokenBtn.addEventListener('click', () => {
    // Generate a new unused token, add to tokens object
    let tries = 0;
    let newToken = '';
    do {
      newToken = generateRandomToken();
      tries++;
      // Prevent infinite loop
      if (tries > 100) break;
    } while(newToken in tokens);

    if (newToken) {
      tokens[newToken] = false;
      saveTokens();
      renderTokenList();
      alert('Token baru dibuat: ' + newToken + '\nSalin dan bagikan ke responden.');
    }
  });

  // Export data click
  exportDataBtn.addEventListener('click', () => {
    const dataExport = {
      tokens,
      votes
    };
    const jsonStr = JSON.stringify(dataExport, null, 2);
    // Show JSON text area for copying
    importExportArea.value = jsonStr;
    importExportArea.style.display = 'block';
    confirmImportBtn.style.display = 'none';
    importExportArea.focus();
    importExportArea.select();
  });

  // Import data click
  importDataBtn.addEventListener('click', () => {
    importExportArea.value = '';
    importExportArea.style.display = 'block';
    confirmImportBtn.style.display = 'inline-block';
    importExportArea.focus();
  });

  // Confirm import click
  confirmImportBtn.addEventListener('click', () => {
    const rawData = importExportArea.value.trim();
    if (!rawData) {
      alert('Data impor tidak boleh kosong.');
      return;
    }
    try {
      const parsed = JSON.parse(rawData);
      if (typeof parsed !== 'object' || !parsed.tokens || !parsed.votes) {
        alert('Format data tidak sesuai.');
        return;
      }
      tokens = parsed.tokens;
      votes = parsed.votes;
      saveTokens();
      saveVotes();
      renderTokenList();
      renderResults();
      importExportArea.style.display = 'none';
      confirmImportBtn.style.display = 'none';
      alert('Data berhasil diimpor.');
    } catch {
      alert('Gagal mengimpor data. Pastikan format JSON benar.');
    }
  });

  // Initial startup
  function startup() {
    loadTokens();
    loadVotes();
    checkAdminSession();
    resetRespondentViews();
  }

  startup();
})();
</script>
</body>
</html>



