<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Polling Lomba Menggambar dan Mewarnai Pesta Gotilon 2025</title>
<style>
  /* Color theme: dark red to orange gradient and accents */
  :root {
    --dark-red: #7B1B1B;
    --medium-red: #A52A2A;
    --orange: #FF6F31;
    --light-orange: #FFA54C;
    --background-bg: #fff5f2;
    --text-light: #f9f4f0;
    --text-dark: #3b1c1c;
  }

  * {
    box-sizing: border-box;
  }

  body {
    margin: 0;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    background: var(--background-bg);
    color: var(--dark-red);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 1rem;
  }

  header {
    text-align: center;
    margin-bottom: 1rem;
  }

  header h1 {
    font-size: 1.8rem;
    font-weight: 700;
    background: linear-gradient(90deg, var(--dark-red), var(--orange));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin: 0;
  }

  main {
    max-width: 480px;
    width: 100%;
    display: flex;
    flex-direction: column;
    gap: 2rem;
  }

  section {
    background: white;
    border-radius: 10px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.12);
    padding: 1.5rem 2rem;
  }

  h2 {
    margin-top: 0;
    margin-bottom: 1rem;
    color: var(--medium-red);
    border-bottom: 2px solid var(--orange);
    padding-bottom: 0.3rem;
  }

  /* RESPONDENT SECTION */

  #respondent-section {
  }

  #token-input-group {
    display: flex;
    flex-direction: column;
    margin-bottom: 1rem;
  }

  #token-input-group label {
    font-weight: 600;
    margin-bottom: 0.3rem;
  }

  #token-input-group input[type="text"] {
    padding: 0.5rem 0.7rem;
    font-size: 1rem;
    border: 2px solid var(--medium-red);
    border-radius: 6px;
    outline-offset: 2px;
    transition: border-color 0.3s ease;
  }
  #token-input-group input[type="text"]:focus {
    border-color: var(--orange);
  }

  button {
    background-color: var(--dark-red);
    color: var(--text-light);
    border: none;
    padding: 0.6rem 1.2rem;
    border-radius: 6px;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    transition: background-color 0.3s ease;
    user-select: none;
  }
  button:hover:not(:disabled) {
    background-color: var(--orange);
  }
  button:disabled {
    background-color: #bbb;
    cursor: not-allowed;
  }

  #poll-options {
    margin-top: 1rem;
  }

  .poll-group {
    margin-bottom: 1rem;
  }

  .poll-label {
    font-weight: 600;
    margin-bottom: 0.5rem;
    display: block;
    color: var(--medium-red);
  }

  select {
    width: 100%;
    padding: 0.5rem;
    font-size: 1rem;
    border-radius: 6px;
    border: 2px solid var(--medium-red);
    outline-offset: 2px;
    transition: border-color 0.3s ease;
  }
  select:focus {
    border-color: var(--orange);
  }

  #message-respondent {
    margin-top: 1rem;
    font-weight: 600;
  }
  #message-respondent.error {
    color: #b71c1c;
  }
  #message-respondent.success {
    color: #2a7a2a;
  }

  /* ADMIN SECTION */

  #admin-section {
  }

  #admin-login-group label {
    font-weight: 600;
    margin-bottom: 0.3rem;
    display: block;
  }

  #admin-login-group input[type="password"] {
    width: 100%;
    padding: 0.5rem;
    font-size: 1rem;
    border-radius: 6px;
    border: 2px solid var(--medium-red);
    outline-offset: 2px;
    transition: border-color 0.3s ease;
  }
  #admin-login-group input[type="password"]:focus {
    border-color: var(--orange);
  }

  #admin-message {
    margin-top: 0.7rem;
    font-weight: 600;
  }

  #admin-message.error {
    color: #b71c1c;
  }
  #admin-message.success {
    color: #2a7a2a;
  }

  #admin-controls {
    margin-top: 1rem;
  }

  #logout-button {
    margin-top: 1rem;
    background-color: #b71c1c;
  }

  #logout-button:hover {
    background-color: #d13b3b;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
    font-size: 0.9rem;
  }

  th, td {
    padding: 0.45rem 0.7rem;
    text-align: center;
    border: 1px solid #dcac7a;
  }

  th {
    background: var(--orange);
    color: var(--text-light);
  }

  #tokens-list-wrapper {
    max-height: 180px;
    overflow-y: auto;
    margin-top: 1rem;
    border: 1px solid var(--medium-red);
    border-radius: 6px;
  }

  #tokens-list {
    margin: 0;
    padding: 0;
    list-style: none;
  }

  #tokens-list li {
    padding: 0.25rem 0.5rem;
    border-bottom: 1px solid #ffbb8322;
    font-family: monospace;
    display: flex;
    justify-content: space-between;
  }

  /* Responsive */
  @media (max-width: 520px) {
    main {
      max-width: 100%;
      padding: 0 0.5rem;
    }
  }
</style>
</head>
<body>

<header>
  <h1>Polling Lomba Menggambar dan Mewarnai Pesta Gotilon 2025</h1>
</header>

<main>
  <section id="respondent-section" aria-label="Polling Responden">
    <h2>Polling Responden</h2>

    <div id="token-input-group">
      <label for="token-input">Masukkan Token Anda:</label>
      <input type="text" id="token-input" autocomplete="off" spellcheck="false" aria-describedby="token-help" />
      <small id="token-help">Token hanya bisa dipakai sekali dan didapat dari admin.</small>
      <button id="token-verify-btn">Gunakan Token</button>
    </div>

    <div id="poll-options" style="display:none;">
      <div class="poll-group">
        <label for="lomba-select" class="poll-label">Pilih Lomba:</label>
        <select id="lomba-select" aria-required="true">
          <option value="" disabled selected>Pilih lomba</option>
          <option value="mewarnai">Mewarnai</option>
          <option value="menggambar">Menggambar</option>
        </select>
      </div>

      <div class="poll-group">
        <label for="sector-select" class="poll-label">Pilih Sektor:</label>
        <select id="sector-select" aria-required="true" disabled>
          <option value="" disabled selected>Pilih sektor</option>
          <option value="Sektor 1">Sektor 1</option>
          <option value="Sektor 2">Sektor 2</option>
          <option value="Sektor 3">Sektor 3</option>
          <option value="Sektor 4">Sektor 4</option>
          <option value="Sektor 5">Sektor 5</option>
          <option value="Sektor 6">Sektor 6</option>
          <option value="Sektor 7">Sektor 7</option>
        </select>
      </div>

      <button id="submit-vote-btn" disabled>Submit Vote</button>
    </div>

    <p id="message-respondent" role="alert" aria-live="assertive"></p>
  </section>

  <section id="admin-section" aria-label="Panel Admin">
    <h2>Admin Panel</h2>
    <div id="admin-login-group">
      <label for="admin-password-input">Password Admin:</label>
      <input type="password" id="admin-password-input" autocomplete="off" aria-describedby="admin-password-help" />
      <small id="admin-password-help">Masukkan password untuk mengakses hasil dan token.</small>
      <button id="admin-login-btn">Login</button>
    </div>
    <p id="admin-message" role="alert" aria-live="assertive"></p>

    <div id="admin-controls" style="display:none;">

      <h3>Hasil Polling</h3>
      <table aria-label="Hasil Polling">
        <thead>
          <tr>
            <th>Lomba</th>
            <th>Sektor</th>
            <th>Jumlah Vote</th>
          </tr>
        </thead>
        <tbody id="results-body">
          <!-- Filled by JS -->
        </tbody>
      </table>

      <h3>Kelola Token</h3>
      <button id="generate-token-btn">Buat Token Baru</button>
      <label style="margin-left: 0.8rem; font-weight: 600;" for="num-tokens-select">Jumlah:</label>
      <select id="num-tokens-select" style="width: 80px;">
        <option value="1" selected>1</option>
        <option value="5">5</option>
        <option value="10">10</option>
      </select>

      <div id="tokens-list-wrapper" aria-live="polite" aria-atomic="true" aria-relevant="additions removals">
        <ul id="tokens-list" aria-label="Daftar Token"></ul>
      </div>

      <button id="logout-button">Logout</button>

    </div>
  </section>
</main>

<script>
  // Constants
  const adminPassword = "semutsektor32025";
  const TOKEN_STORAGE_KEY = "polling_lomba_tokens";
  const VOTES_STORAGE_KEY = "polling_lomba_votes";
  const ADMIN_SESSION_KEY = "polling_lomba_admin_logged_in";

  // DOM Elements: Respondent
  const tokenInput = document.getElementById("token-input");
  const tokenVerifyBtn = document.getElementById("token-verify-btn");
  const pollOptions = document.getElementById("poll-options");
  const lombaSelect = document.getElementById("lomba-select");
  const sectorSelect = document.getElementById("sector-select");
  const submitVoteBtn = document.getElementById("submit-vote-btn");
  const messageRespondent = document.getElementById("message-respondent");

  // DOM Elements: Admin
  const adminPasswordInput = document.getElementById("admin-password-input");
  const adminLoginBtn = document.getElementById("admin-login-btn");
  const adminMessage = document.getElementById("admin-message");
  const adminControls = document.getElementById("admin-controls");
  const resultsBody = document.getElementById("results-body");
  const generateTokenBtn = document.getElementById("generate-token-btn");
  const tokensList = document.getElementById("tokens-list");
  const logoutButton = document.getElementById("logout-button");
  const numTokensSelect = document.getElementById("num-tokens-select");

  // State
  let tokens = {};
  let votes = [];
  let currentToken = null;
  let adminLoggedIn = false;

  // Helper Functions

  function saveTokens() {
    localStorage.setItem(TOKEN_STORAGE_KEY, JSON.stringify(tokens));
  }

  function loadTokens() {
    const stored = localStorage.getItem(TOKEN_STORAGE_KEY);
    tokens = stored ? JSON.parse(stored) : {};
  }

  function saveVotes() {
    localStorage.setItem(VOTES_STORAGE_KEY, JSON.stringify(votes));
  }

  function loadVotes() {
    const stored = localStorage.getItem(VOTES_STORAGE_KEY);
    votes = stored ? JSON.parse(stored) : [];
  }

  function saveAdminSession() {
    localStorage.setItem(ADMIN_SESSION_KEY, adminLoggedIn ? "true" : "false");
  }

  function loadAdminSession() {
    const stored = localStorage.getItem(ADMIN_SESSION_KEY);
    adminLoggedIn = stored === "true";
  }

  // Token generator (random 8-char alphanumeric uppercase)
  function generateToken() {
    const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
    let token = "";
    for (let i = 0; i < 8; i++) {
      token += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return token;
  }

  // Populate tokens list in admin UI
  function renderTokensList() {
    tokensList.innerHTML = "";
    const tokenEntries = Object.entries(tokens)
      .sort((a, b) => a[0].localeCompare(b[0]));
    if(tokenEntries.length === 0){
      const li = document.createElement("li");
      li.textContent = "Belum ada token dibuat.";
      li.style.fontStyle = "italic";
      tokensList.appendChild(li);
      return;
    }
    for (const [tk, used] of tokenEntries) {
      const li = document.createElement("li");
      li.textContent = tk;
      const statusSpan = document.createElement("span");
      statusSpan.textContent = used ? "✓ Dipakai" : "✗ Belum dipakai";
      statusSpan.style.color = used ? "#2a7a2a" : "#b71c1c";
      statusSpan.style.fontWeight = "700";
      li.appendChild(statusSpan);
      tokensList.appendChild(li);
    }
  }

  // Compute voting results summary (count by contest and sector)
  function computeResults() {
    // Format: { lomba: { sektor: count } }
    const resultMap = {};
    for(const vote of votes){
      if(!resultMap[vote.lomba]){
        resultMap[vote.lomba] = {};
      }
      if(!resultMap[vote.lomba][vote.sektor]){
        resultMap[vote.lomba][vote.sektor] = 0;
      }
      resultMap[vote.lomba][vote.sektor]++;
    }
    return resultMap;
  }

  // Render voting results in admin UI
  function renderResults() {
    const results = computeResults();
    resultsBody.innerHTML = "";

    const lombaNames = { mewarnai:"Mewarnai", menggambar:"Menggambar" };
    const sectors = ["Sektor 1","Sektor 2","Sektor 3","Sektor 4","Sektor 5","Sektor 6","Sektor 7"];

    let rows = 0;
    for(let lombaKey of Object.keys(lombaNames)){
      for(let sektor of sectors){
        const count = (results[lombaKey] && results[lombaKey][sektor]) || 0;
        if(count > 0){
          const tr = document.createElement("tr");
          const tdLomba = document.createElement("td");
          tdLomba.textContent = lombaNames[lombaKey];
          const tdSektor = document.createElement("td");
          tdSektor.textContent = sektor;
          const tdCount = document.createElement("td");
          tdCount.textContent = count;
          tr.appendChild(tdLomba);
          tr.appendChild(tdSektor);
          tr.appendChild(tdCount);
          resultsBody.appendChild(tr);
          rows++;
        }
      }
    }
    if(rows === 0){
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 3;
      td.textContent = "Belum ada suara masuk.";
      td.style.fontStyle = "italic";
      tr.appendChild(td);
      resultsBody.appendChild(tr);
    }
  }

  // Reset respondent poll UI to initial state
  function resetRespondentUI() {
    currentToken = null;
    tokenInput.value = "";
    lombaSelect.value = "";
    sectorSelect.value = "";
    sectorSelect.disabled = true;
    submitVoteBtn.disabled = true;
    pollOptions.style.display = "none";
    messageRespondent.textContent = "";
    tokenInput.focus();
  }

  // Respondent event handlers

  tokenVerifyBtn.addEventListener("click", () => {
    messageRespondent.textContent = "";
    const token = tokenInput.value.trim().toUpperCase();

    if(!token){
      messageRespondent.textContent = "Token wajib diisi.";
      messageRespondent.className = "error";
      return;
    }
    if(!tokens.hasOwnProperty(token)){
      messageRespondent.textContent = "Token tidak valid.";
      messageRespondent.className = "error";
      return;
    }
    if(tokens[token] === true){
      messageRespondent.textContent = "Token sudah digunakan.";
      messageRespondent.className = "error";
      return;
    }
    // Valid token
    currentToken = token;
    pollOptions.style.display = "block";
    messageRespondent.textContent = "Token diterima! Silakan pilih lomba dan sektor.";
    messageRespondent.className = "success";
    // Enable lomba select
    lombaSelect.disabled = false;
    sectorSelect.disabled = true;
    submitVoteBtn.disabled = true;
    // Focus lomba select
    lombaSelect.focus();
  });

  lombaSelect.addEventListener("change", () => {
    if(lombaSelect.value){
      sectorSelect.disabled = false;
      submitVoteBtn.disabled = true;
      sectorSelect.value = "";
      sectorSelect.focus();
    } else {
      sectorSelect.disabled = true;
      sectorSelect.value = "";
      submitVoteBtn.disabled = true;
    }
  });

  sectorSelect.addEventListener("change", () => {
    if(sectorSelect.value){
      submitVoteBtn.disabled = false;
    } else {
      submitVoteBtn.disabled = true;
    }
  });

  submitVoteBtn.addEventListener("click", () => {
    const lomba = lombaSelect.value;
    const sektor = sectorSelect.value;

    if(!currentToken || !lomba || !sektor){
      messageRespondent.textContent = "Mohon isi semua pilihan dengan benar.";
      messageRespondent.className = "error";
      return;
    }

    // Save vote
    votes.push({ token: currentToken, lomba, sektor });
    // Mark token as used
    tokens[currentToken] = true;
    saveVotes();
    saveTokens();

    messageRespondent.textContent = "Terima kasih, suara Anda telah direkam.";
    messageRespondent.className = "success";

    // Return to initial respondent UI after a short delay
    setTimeout(() => {
      resetRespondentUI();
    }, 1600);
  });

  // Admin event handlers

  adminLoginBtn.addEventListener("click", () => {
    adminMessage.textContent = "";
    const pass = adminPasswordInput.value;

    if(pass === adminPassword){
      adminLoggedIn = true;
      saveAdminSession();
      adminPasswordInput.value = "";
      adminMessage.textContent = "Login admin berhasil.";
      adminMessage.className = "success";
      showAdminControls(true);
      renderResults();
      renderTokensList();
    } else {
      adminMessage.textContent = "Password salah, coba lagi.";
      adminMessage.className = "error";
      showAdminControls(false);
    }
  });

  logoutButton.addEventListener("click", () => {
    adminLoggedIn = false;
    saveAdminSession();
    showAdminControls(false);
    adminMessage.textContent = "Anda telah logout.";
    adminMessage.className = "success";
  });

  // Show or hide admin main controls
  function showAdminControls(show){
    adminControls.style.display = show ? "block" : "none";
    document.getElementById("admin-login-group").style.display = show ? "none" : "block";
  }

  // Generate tokens
  generateTokenBtn.addEventListener("click", () => {
    const count = parseInt(numTokensSelect.value, 10) || 1;
    let created = 0;

    // Avoid duplicate tokens
    for(let i=0;i<count;){
      const newToken = generateToken();
      if(!tokens.hasOwnProperty(newToken)){
        tokens[newToken] = false;
        i++;
        created++;
      }
    }
    saveTokens();
    renderTokensList();
    adminMessage.textContent = `Berhasil membuat ${created} token baru.`;
    adminMessage.className = "success";
  });

  // Initialization
  function init() {
    loadTokens();
    loadVotes();
    loadAdminSession();

    if(adminLoggedIn){
      showAdminControls(true);
      renderResults();
      renderTokensList();
    } else {
      showAdminControls(false);
    }

    resetRespondentUI();
  }

  init();

</script>

</body>
</html>

